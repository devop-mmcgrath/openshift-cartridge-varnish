#!/bin/bash -eu

source $OPENSHIFT_CARTRIDGE_SDK_BASH
CALL=$1
pidfile="${OPENSHIFT_VARNISH_DIR}var/run/varnish.pid"

function start {

  if [ -f $pidfile ]; then
    pid=$(<$pidfile)
    # Check validity of pidfile
    if [ -n "$pid" ]; then
      varnish_procs=$( pgrep -u $OPENSHIFT_GEAR_UUID varnishd )
      for p in $varnish_procs; do
        if [ "$p" == "$pid" ]; then
          # This is the only case where the pidfile is valid
	  return
        fi
      done
    fi
    rm $pidfile
  fi

  "${OPENSHIFT_VARNISH_DIR}usr/sbin/varnishd" -f $OPENSHIFT_REPO_DIR/default.vcl \
    -n "${OPENSHIFT_VARNISH_DIR}var/lib/varnish" -P "${OPENSHIFT_VARNISH_DIR}var/run/varnish.pid" \
    -u "$OPENSHIFT_GEAR_UUID" \
    -a "$OPENSHIFT_VARNISH_IP":"$OPENSHIFT_VARNISH_PORT" \
    -p vmod_dir="${OPENSHIFT_VARNISH_DIR}usr/lib64/varnish/vmods/" \
    -p vcl_dir="${OPENSHIFT_REPO_DIR}" \
    -T "$OPENSHIFT_VARNISH_ADMIN_IP":"$OPENSHIFT_VARNISH_ADMIN_PORT"
  ret=$?

  if [ $ret -ne 0 ]; then
    client_result "Varnish failed to start - $ret" 1>&2
    rm $pidfile
    return $ret
  fi
}

function stop {

  varnish_procs=$( pgrep -u $OPENSHIFT_GEAR_UUID varnishd )
  pid_to_kill=
  if [ -f $pidfile ]; then
    pid=$(<$pidfile)
    if [ -n "$pid" ]; then
      for p in $varnish_procs; do
        if [ "$p" == "$pid" ]; then
          pid_to_kill=$p
          break
        fi
      done

      if [ -n "$pid_to_kill" ]; then
        kill -s SIGTERM $pid
      fi
    fi
    rm $pidfile
  fi

  # If the pidfile is stale, but other varnish procs exist, kill them.
  # We don't kill other varnish procs if we found the one in the pidfile.
  # Is this the right thing to do?
  if [ -z "$pid_to_kill" ]; then
    kill $varnish_procs
  fi

}

function restart {
  stop
  start
}

function status {
  if [ -f $pidfile ]; then
    client_result  "Varnish cache is running"
  else 
    client_result "Varnish cache is stopped"
  fi
}

function not_implemented {
  echo "$CALL: not implemented"
}

case "$1" in
  start)         start ;;
  stop)          stop ;;
  restart)       restart ;;
  status)        status ;;
  reload)        not_implemented ;;
  tidy)          not_implemented ;;
  pre-build)     not_implemented ;;
  build)         not_implemented ;;
  deploy)        not_implemented ;;
  post-deploy)   not_implemented ;;
  pre-snapshot)  not_implemented ;;
  post-snapshot) not_implemented ;;
  pre-restore)   not_implemented ;;
  post-restore)  not_implemented ;;
  pre-receive)   not_implemented ;;
  update-configuration) not_implemented ;;
  *)           exit 0
esac

exit 0
